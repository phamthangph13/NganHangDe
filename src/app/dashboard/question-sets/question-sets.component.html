<!-- QUESTION SETS LIST VIEW -->
<div class="container" *ngIf="!activeQuestionSet">
  <div class="header-container">
    <h2>Quản lý bộ câu hỏi</h2>
    <button class="btn btn-primary" (click)="toggleQuestionSetForm()">
      {{ showQuestionSetForm ? 'Hủy' : 'Thêm bộ câu hỏi' }}
    </button>
  </div>
  
  <!-- Search & Filter -->
  <div class="search-container">
    <input 
      type="text" 
      class="form-control" 
      placeholder="Tìm kiếm bộ câu hỏi..." 
      [(ngModel)]="searchText" 
      (input)="filterQuestionSets()">
  </div>
  
  <!-- Question Set Form -->
  <div class="form-container" *ngIf="showQuestionSetForm">
    <h3>{{ isEditingQuestionSet ? 'Cập nhật bộ câu hỏi' : 'Thêm bộ câu hỏi mới' }}</h3>
    <form [formGroup]="questionSetForm" (ngSubmit)="submitQuestionSetForm()">
      <div class="form-group">
        <label for="title">Tiêu đề *</label>
        <input type="text" id="title" formControlName="title" class="form-control" required>
        <div class="error-message" *ngIf="questionSetForm.get('title')?.invalid && questionSetForm.get('title')?.touched">
          Vui lòng nhập tiêu đề
        </div>
      </div>
      
      <div class="form-group">
        <label for="subjectId">Môn học *</label>
        <select id="subjectId" formControlName="subjectId" class="form-control" required>
          <option value="">-- Chọn môn học --</option>
          <option *ngFor="let subject of subjects" [value]="subject.id">{{ subject.name }}</option>
        </select>
        <div class="error-message" *ngIf="questionSetForm.get('subjectId')?.invalid && questionSetForm.get('subjectId')?.touched">
          Vui lòng chọn môn học
        </div>
      </div>
      
      <div class="form-group">
        <label for="gradeLevel">Lớp *</label>
        <select id="gradeLevel" formControlName="gradeLevel" class="form-control" required>
          <option value="">-- Chọn lớp --</option>
          <option *ngFor="let grade of gradeLevels" [value]="grade">{{ grade }}</option>
        </select>
        <div class="error-message" *ngIf="questionSetForm.get('gradeLevel')?.invalid && questionSetForm.get('gradeLevel')?.touched">
          Vui lòng chọn lớp
        </div>
      </div>
      
      <div class="form-group">
        <label for="description">Mô tả</label>
        <textarea id="description" formControlName="description" class="form-control" rows="3"></textarea>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleQuestionSetForm()">Hủy</button>
        <button type="submit" class="btn btn-primary" [disabled]="questionSetForm.invalid">Lưu</button>
      </div>
    </form>
  </div>
  
  <!-- Question Sets List -->
  <div class="question-sets-container">
    <div *ngIf="filteredQuestionSets.length === 0" class="empty-message">
      Không có bộ câu hỏi nào. Hãy tạo bộ câu hỏi mới.
    </div>
    
    <div class="question-set-card" *ngFor="let questionSet of filteredQuestionSets">
      <div class="question-set-header">
        <h3>{{ questionSet.title }}</h3>
        <div class="badge-container">
          <span class="badge bg-info">{{ questionSet.subjectName }}</span>
          <span class="badge bg-secondary">Lớp {{ questionSet.gradeLevel }}</span>
        </div>
      </div>
      
      <p class="description">{{ questionSet.description }}</p>
      
      <div class="question-stats">
        <span><strong>{{ questionSet.questionCount }}</strong> câu hỏi</span>
        <span>Tạo ngày: {{ questionSet.createdAt | date:'dd/MM/yyyy' }}</span>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-outline-primary" (click)="viewQuestionSet(questionSet)">Xem chi tiết</button>
        <button class="btn btn-outline-warning" (click)="editQuestionSet(questionSet)">Sửa</button>
        <button class="btn btn-outline-danger" (click)="deleteQuestionSet(questionSet.id)">Xóa</button>
      </div>
    </div>
  </div>




  <!-- Question Validation Form -->
  <div class="form-container" *ngIf="showQuestionValidation">
    <h3>Kiểm tra chất lượng câu hỏi</h3>
    <p class="text-muted">Sử dụng AI để kiểm tra câu hỏi theo tiêu chuẩn cấp độ và văn bản dư thừa.</p>
    
    <form (ngSubmit)="submitQuestionValidation()">
      <div class="form-group">
        <label for="validationQuestionContent">Nội dung câu hỏi *</label>
        <textarea 
          id="validationQuestionContent" 
          [(ngModel)]="validationQuestionContent" 
          name="validationQuestionContent"
          class="form-control" 
          rows="4"
          placeholder="Nhập nội dung câu hỏi cần kiểm tra..."
          required
        ></textarea>
      </div>
      
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label for="validationQuestionType">Loại câu hỏi</label>
            <select id="validationQuestionType" [(ngModel)]="validationQuestionType" name="validationQuestionType" 
                    class="form-control" (change)="onValidationTypeChange()">
              <option *ngFor="let type of questionTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="validationGradeLevel">Cấp độ lớp</label>
            <select id="validationGradeLevel" [(ngModel)]="validationGradeLevel" name="validationGradeLevel" class="form-control">
              <option *ngFor="let grade of gradeLevels" [value]="grade">Lớp {{ grade }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="validationSubject">Môn học</label>
            <input type="text" id="validationSubject" [(ngModel)]="validationSubject" name="validationSubject" 
                   class="form-control" placeholder="Ví dụ: Toán học">
          </div>
        </div>
      </div>
      
      <!-- Options for validation -->
      <div *ngIf="validationQuestionType !== 'essay'">
        <div class="options-header">
          <h5>Các lựa chọn</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" (click)="addValidationOption()">
            <i class="bi bi-plus-circle"></i> Thêm lựa chọn
          </button>
        </div>
        
        <div class="validation-options">
          <div class="option-group" *ngFor="let option of validationOptions; let i = index">
            <div class="option-row">
              <div class="option-marker">{{ getOptionLabel(i) }}</div>
              <input type="text" [(ngModel)]="validationOptions[i]" [name]="'validationOption' + i" 
                     class="form-control" placeholder="Nhập nội dung lựa chọn...">
              <button type="button" class="btn btn-sm btn-outline-danger" 
                      *ngIf="validationOptions.length > 2" (click)="removeValidationOption(i)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleQuestionValidation()">Hủy</button>
        <button type="submit" class="btn btn-warning" [disabled]="!validationQuestionContent.trim() || isValidating">
          <i class="bi" [ngClass]="isValidating ? 'bi-hourglass' : 'bi-check-circle'"></i>
          {{ isValidating ? 'Đang kiểm tra...' : 'Kiểm tra câu hỏi' }}
        </button>
      </div>
    </form>
    
    <!-- Validation Result -->
    <div class="validation-result" *ngIf="validationResult">
      <h4>Kết quả kiểm tra</h4>
      
      <div class="result-card">
        <div class="result-header">
          <span class="badge" [ngClass]="validationResult.isValid ? 'bg-success' : 'bg-warning'">
            {{ validationResult.isValid ? 'Câu hỏi đạt chất lượng' : 'Phát hiện vấn đề' }}
          </span>
          <span class="badge bg-primary ms-2" *ngIf="validationResult.bloomLevel">
            Cấp độ: {{ validationResult.bloomLevel }}
          </span>
        </div>
        
        <!-- Bloom Level Justification -->
        <div class="bloom-level-detail" *ngIf="validationResult.bloomLevelJustification">
          <p class="text-muted"><strong>Giải thích cấp độ:</strong> {{ validationResult.bloomLevelJustification }}</p>
        </div>
        
        <div class="validation-issues" *ngIf="!validationResult.isValid && validationResult.issues.length > 0">
          <h6><i class="bi bi-exclamation-triangle"></i> Các vấn đề được phát hiện:</h6>
          <div class="issue-item" *ngFor="let issue of validationResult.issues">
            <span class="issue-type badge" [ngClass]="getValidationSeverityClass(issue.severity)">
              {{ getValidationTypeLabel(issue.type) }}
            </span>
            <span class="issue-description">{{ issue.description }}</span>
          </div>
          
          <div class="mt-3">
            <p class="text-warning"><i class="bi bi-info-circle"></i> Câu hỏi này cần được chỉnh sửa thủ công trước khi sử dụng.</p>
          </div>
        </div>
        
        <div *ngIf="validationResult.isValid" class="text-success">
          <p><i class="bi bi-check-circle"></i> Câu hỏi này đạt chất lượng và có thể sử dụng.</p>
        </div>
      </div>
    </div>
  </div>
  

</div>

<!-- QUESTION SET DETAIL VIEW -->
<div class="container" *ngIf="activeQuestionSet">
  <!-- File input elements for image uploading -->
  <input type="file" id="questionImageUpload" accept="image/*" style="display: none;" (change)="handleImageUpload($event, 'content')">
  <input type="file" id="optionImageUpload" accept="image/*" style="display: none;" (change)="handleOptionImageUpload($event)">
  
  <div class="header-container">
    <div class="back-button" (click)="backToList()">
      <i class="bi bi-arrow-left"></i> Quay lại
    </div>
    <h2>{{ activeQuestionSet.title }}</h2>
    <div class="badge-container">
      <span class="badge bg-info">{{ activeQuestionSet.subjectName }}</span>
      <span class="badge bg-secondary">Lớp {{ activeQuestionSet.gradeLevel }}</span>
    </div>
  </div>
  
  <p class="description">{{ activeQuestionSet.description }}</p>
  
  <!-- Question management section header -->
  <div class="header-container">
    <h3>Danh sách câu hỏi ({{ activeQuestionSet.questions.length }})</h3>
    <div class="button-group">
      <button class="btn btn-primary add-question-btn" (click)="toggleQuestionForm()" *ngIf="!showQuestionForm && !showAIQuestionForm">
        <i class="bi bi-plus-circle"></i> Thêm câu hỏi
      </button>
      <button class="btn btn-success add-question-btn" (click)="toggleAIQuestionForm()" *ngIf="!showQuestionForm && !showAIQuestionForm && !showDualGeminiForm && !showQuestionValidation">
        <i class="bi bi-robot"></i> Tạo câu hỏi bằng AI
      </button>
      <button class="btn btn-info add-question-btn" (click)="toggleDualGeminiForm()" *ngIf="!showQuestionForm && !showAIQuestionForm && !showDualGeminiForm && !showQuestionValidation">
        <i class="bi bi-shield-check"></i> AI với kiểm tra chất lượng
      </button>
      <button class="btn btn-warning add-question-btn" (click)="toggleQuestionValidation()" *ngIf="!showQuestionForm && !showAIQuestionForm && !showDualGeminiForm && !showQuestionValidation">
        <i class="bi bi-check-circle"></i> Kiểm tra câu hỏi
      </button>
    </div>
  </div>
  
  <!-- Empty state with call-to-action when no questions exist -->
  <div *ngIf="activeQuestionSet.questions.length === 0 && !showQuestionForm && !showAIQuestionForm && !showDualGeminiForm && !showQuestionValidation" class="empty-state">
    <div class="empty-state-icon">
      <i class="bi bi-clipboard-plus"></i>
    </div>
    <h4>Chưa có câu hỏi nào</h4>
    <p>Hãy thêm câu hỏi đầu tiên vào bộ câu hỏi này</p>
    <div class="button-group">
      <button class="btn btn-primary" (click)="toggleQuestionForm()">
        <i class="bi bi-plus-circle"></i> Tạo câu hỏi mới
      </button>
      <button class="btn btn-success" (click)="toggleAIQuestionForm()">
        <i class="bi bi-robot"></i> Tạo câu hỏi bằng AI
      </button>
      <button class="btn btn-info" (click)="toggleDualGeminiForm()">
        <i class="bi bi-shield-check"></i> AI với kiểm tra chất lượng
      </button>
      <button class="btn btn-warning" (click)="toggleQuestionValidation()">
        <i class="bi bi-check-circle"></i> Kiểm tra câu hỏi
      </button>
    </div>
  </div>
  
  <!-- Questions List -->
  <div class="questions-container" *ngIf="activeQuestionSet.questions.length > 0 && !showQuestionForm && !showAIQuestionForm && !showDualGeminiForm && !showQuestionValidation">
    <div class="question-card" *ngFor="let question of activeQuestionSet.questions; let i = index">
      <div class="question-header">
        <div class="question-number">Câu {{ i + 1 }}</div>
        <div class="question-type">{{ question.type === 'single' ? 'Trắc nghiệm - Một đáp án' : 
          question.type === 'multiple' ? 'Trắc nghiệm - Nhiều đáp án' : 'Tự luận' }}</div>
        <div class="question-level" *ngIf="question.bloomLevel">
          <span class="badge bg-info">{{ question.bloomLevel }}</span>
        </div>
      </div>
      
      <div class="question-content" [innerHTML]="getSafeHtml(question.content)"></div>
      
      <!-- Options for multiple choice questions -->
      <div class="options-container" *ngIf="question.type !== 'essay' && question.options">
        <div class="option" *ngFor="let option of question.options; let optIndex = index"
             [class.correct]="question.correctAnswers?.includes(optIndex)">
          <div class="option-marker">{{ getOptionLabel(optIndex) }}</div>
          <div class="option-content" [innerHTML]="getSafeHtml(option.content)"></div>
        </div>
      </div>
      
      <div class="question-actions">
        <button class="btn btn-sm btn-outline-warning" (click)="editQuestion(question)">Sửa</button>
        <button class="btn btn-sm btn-outline-danger" (click)="deleteQuestion(question.id)">Xóa</button>
      </div>
    </div>
  </div>
  
  <!-- Question Form -->
  <div class="form-container" *ngIf="showQuestionForm">
    <h3>{{ isEditingQuestion ? 'Cập nhật câu hỏi' : 'Thêm câu hỏi mới' }}</h3>
    
    <form [formGroup]="questionForm" (ngSubmit)="submitQuestionForm()">
      <div class="form-group">
        <label for="questionType">Loại câu hỏi *</label>
        <select id="questionType" formControlName="type" class="form-control" (change)="onQuestionTypeChange()">
          <option *ngFor="let type of questionTypes" [value]="type.value">{{ type.label }}</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="bloomLevel">Mức độ Bloom</label>
        <select id="bloomLevel" formControlName="bloomLevel" class="form-control">
          <option value="">Chọn mức độ</option>
          <option value="Nhận biết">Nhận biết</option>
          <option value="Thông hiểu">Thông hiểu</option>
          <option value="Vận dụng">Vận dụng</option>
          <option value="Vận dụng cao">Vận dụng cao</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="questionContent">Nội dung câu hỏi *</label>
        <div class="editor-toolbar">
          <button type="button" class="toolbar-btn" (click)="insertFormat('b')"><i class="bi bi-type-bold"></i></button>
          <button type="button" class="toolbar-btn" (click)="insertFormat('i')"><i class="bi bi-type-italic"></i></button>
          <button type="button" class="toolbar-btn" (click)="insertFormat('u')"><i class="bi bi-type-underline"></i></button>
          <button type="button" class="toolbar-btn" (click)="insertFormat('math')"><i class="bi bi-calculator"></i></button>
          <button type="button" class="toolbar-btn" (click)="insertImage()"><i class="bi bi-image"></i></button>
        </div>
        <textarea 
          id="questionContent" 
          formControlName="content" 
          class="form-control editor-textarea" 
          rows="4"
          placeholder="Nhập nội dung câu hỏi... (hỗ trợ định dạng HTML và công thức LaTeX)"
        ></textarea>
        <div class="error-message" *ngIf="questionForm.get('content')?.invalid && questionForm.get('content')?.touched">
          Vui lòng nhập nội dung câu hỏi
        </div>
      </div>
      
      <!-- Options for multiple choice questions -->
      <div *ngIf="questionForm.get('type')?.value !== 'essay'">
        <div class="options-header">
          <h4>Các lựa chọn</h4>
          <button type="button" class="btn btn-sm btn-outline-primary" (click)="addOption()">
            <i class="bi bi-plus-circle"></i> Thêm lựa chọn
          </button>
        </div>
        
        <div formArrayName="options">
          <div class="option-group" *ngFor="let option of options.controls; let i = index">
            <div class="option-row">
              <div class="option-marker">{{ getOptionLabel(i) }}</div>
              <div class="option-content-editor">
                <div class="editor-toolbar">
                  <button type="button" class="toolbar-btn" (click)="insertOptionFormat(i, 'b')"><i class="bi bi-type-bold"></i></button>
                  <button type="button" class="toolbar-btn" (click)="insertOptionFormat(i, 'i')"><i class="bi bi-type-italic"></i></button>
                  <button type="button" class="toolbar-btn" (click)="insertOptionFormat(i, 'u')"><i class="bi bi-type-underline"></i></button>
                  <button type="button" class="toolbar-btn" (click)="insertOptionFormat(i, 'math')"><i class="bi bi-calculator"></i></button>
                  <button type="button" class="toolbar-btn" (click)="insertOptionImage(i)"><i class="bi bi-image"></i></button>
                </div>
                <textarea 
                  [formControlName]="i" 
                  class="form-control editor-textarea" 
                  placeholder="Nhập nội dung lựa chọn..."
                ></textarea>
              </div>
              <div class="option-actions">
                <button type="button" class="btn btn-sm" 
                  [class.btn-success]="isCorrectAnswer(i)" 
                  [class.btn-outline-secondary]="!isCorrectAnswer(i)" 
                  (click)="toggleCorrectAnswer(i)">
                  <i class="bi" [class.bi-check-circle-fill]="isCorrectAnswer(i)" [class.bi-circle]="!isCorrectAnswer(i)"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" *ngIf="options.length > 2" (click)="removeOption(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-info">
          <p><i class="bi bi-info-circle"></i> Nhấn vào nút tròn để đánh dấu đáp án đúng.</p>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleQuestionForm()">Hủy</button>
        <button type="submit" class="btn btn-primary" [disabled]="questionForm.invalid">Lưu</button>
      </div>
    </form>
  </div>
  
  <!-- AI Question Generator Form -->
  <div class="form-container" *ngIf="showAIQuestionForm">
    <h3>Tạo câu hỏi bằng AI</h3>
    
    <form (ngSubmit)="submitAIQuestionForm()">
      <div class="form-group">
        <label for="aiPrompt">Nhập chủ đề hoặc nội dung bạn muốn tạo câu hỏi *</label>
        <textarea 
          id="aiPrompt" 
          [(ngModel)]="aiPrompt" 
          name="aiPrompt"
          class="form-control" 
          rows="4"
          placeholder="Ví dụ: Tạo các câu hỏi về phương trình bậc 2 lớp 10"
          required
        ></textarea>
      </div>
      
      <div class="form-group">
        <label for="aiQuestionType">Loại câu hỏi</label>
        <select id="aiQuestionType" [(ngModel)]="aiQuestionType" name="aiQuestionType" class="form-control">
          <option *ngFor="let type of questionTypes" [value]="type.value">{{ type.label }}</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="aiQuestionCount">Số lượng câu hỏi (1-10)</label>
        <input 
          type="number" 
          id="aiQuestionCount" 
          [(ngModel)]="aiQuestionCount" 
          name="aiQuestionCount"
          class="form-control" 
          min="1" 
          max="10" 
          step="1"
        >
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleAIQuestionForm()">Hủy</button>
        <button type="submit" class="btn btn-success" [disabled]="!aiPrompt.trim() || isGeneratingAIQuestions">
          <i class="bi" [ngClass]="isGeneratingAIQuestions ? 'bi-hourglass' : 'bi-robot'"></i>
          {{ isGeneratingAIQuestions ? 'Đang tạo câu hỏi...' : 'Tạo câu hỏi' }}
        </button>
      </div>
    </form>
    
    <!-- AI Generated Questions Preview -->
    <div class="ai-questions-preview" *ngIf="aiGeneratedQuestions.length > 0">
      <h4>Câu hỏi được tạo</h4>
      
      <div class="question-card" *ngFor="let question of aiGeneratedQuestions; let i = index">
        <div class="question-header">
          <div class="question-number">Câu {{ i + 1 }}</div>
          <div class="question-type">{{ question.type === 'single' ? 'Trắc nghiệm - Một đáp án' : 
            question.type === 'multiple' ? 'Trắc nghiệm - Nhiều đáp án' : 'Tự luận' }}</div>
          <div class="question-level" *ngIf="question.bloomLevel">
            <span class="badge bg-info">{{ question.bloomLevel }}</span>
          </div>
        </div>
        
        <div class="question-content" [innerHTML]="getSafeHtml(question.content)"></div>
        
        <!-- Options for multiple choice questions -->
        <div class="options-container" *ngIf="question.type !== 'essay' && question.options">
          <div class="option" *ngFor="let option of question.options; let optIndex = index"
               [class.correct]="question.correctAnswers?.includes(optIndex)">
            <div class="option-marker">{{ getOptionLabel(optIndex) }}</div>
            <div class="option-content" [innerHTML]="getSafeHtml(option.content)"></div>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="aiGeneratedQuestions = []">Hủy</button>
        <button type="button" class="btn btn-success" (click)="saveAIGeneratedQuestions()">Lưu tất cả câu hỏi</button>
      </div>
    </div>
  </div>
  
  <!-- Dual Gemini AI Question Generator Form -->
  <div class="form-container" *ngIf="showDualGeminiForm">
    <h3>Tạo câu hỏi AI với kiểm tra chất lượng</h3>
    
    <form (ngSubmit)="submitDualGeminiForm()">
      <div class="form-group">
        <label for="dualGeminiPrompt">Nhập chủ đề hoặc nội dung bạn muốn tạo câu hỏi *</label>
        <textarea 
          id="dualGeminiPrompt" 
          [(ngModel)]="dualGeminiPrompt" 
          name="dualGeminiPrompt"
          class="form-control" 
          rows="4"
          placeholder="Ví dụ: Tạo các câu hỏi về phương trình bậc 2 lớp 10"
          required
        ></textarea>
      </div>
      
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label for="dualGeminiQuestionType">Loại câu hỏi</label>
            <select id="dualGeminiQuestionType" [(ngModel)]="dualGeminiQuestionType" name="dualGeminiQuestionType" class="form-control">
              <option *ngFor="let type of questionTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="dualGeminiQuestionCount">Số lượng câu hỏi (1-10)</label>
            <input 
              type="number" 
              id="dualGeminiQuestionCount" 
              [(ngModel)]="dualGeminiQuestionCount" 
              name="dualGeminiQuestionCount"
              class="form-control" 
              min="1" 
              max="10" 
              step="1"
            >
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="dualGeminiGradeLevel">Cấp độ lớp</label>
            <select id="dualGeminiGradeLevel" [(ngModel)]="dualGeminiGradeLevel" name="dualGeminiGradeLevel" class="form-control">
              <option *ngFor="let grade of gradeLevels" [value]="grade">Lớp {{ grade }}</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleDualGeminiForm()">Hủy</button>
        <button type="submit" class="btn btn-info" [disabled]="!dualGeminiPrompt.trim() || isGeneratingDualGemini">
          <i class="bi" [ngClass]="isGeneratingDualGemini ? 'bi-hourglass' : 'bi-shield-check'"></i>
          {{ isGeneratingDualGemini ? 'Đang tạo và kiểm tra...' : 'Tạo câu hỏi với kiểm tra' }}
        </button>
      </div>
    </form>
    
    <!-- Dual Gemini Results -->
    <div class="validation-results" *ngIf="showValidationResults && dualGeminiResults.length > 0">
      <h4>Kết quả tạo và kiểm tra câu hỏi</h4>
      
      <div class="question-validation-card" *ngFor="let result of dualGeminiResults; let i = index">
        <div class="question-header">
          <div class="question-number">Câu {{ i + 1 }}</div>
          <div class="validation-status">
            <span class="badge" [ngClass]="result.hasIssues ? 'bg-warning' : 'bg-success'">
              {{ result.hasIssues ? 'Cần kiểm tra' : 'Đạt chất lượng' }}
            </span>
          </div>
        </div>
        
        <div class="question-content" [innerHTML]="getSafeHtml(result.question.content)"></div>
        
        <!-- Bloom Level Display -->
        <div class="bloom-level-info" *ngIf="result.validationResult.bloomLevel">
          <span class="badge bg-primary">Cấp độ: {{ result.validationResult.bloomLevel }}</span>
          <small class="text-muted" *ngIf="result.validationResult.bloomLevelJustification">
            {{ result.validationResult.bloomLevelJustification }}
          </small>
        </div>
        
        <!-- Options for multiple choice questions -->
        <div class="options-container" *ngIf="result.question.type !== 'essay' && result.question.options">
          <div class="option" *ngFor="let option of result.question.options; let optIndex = index"
               [class.correct]="result.question.correctAnswers?.includes(optIndex)">
            <div class="option-marker">{{ getOptionLabel(optIndex) }}</div>
            <div class="option-content" [innerHTML]="getSafeHtml(option.content)"></div>
          </div>
        </div>
        
        <!-- Validation Issues -->
        <div class="validation-issues" *ngIf="result.hasIssues && result.issues.length > 0">
          <h6><i class="bi bi-exclamation-triangle"></i> Vấn đề được phát hiện:</h6>
          <div class="issue-item" *ngFor="let issue of result.issues">
            <span class="issue-type badge" [ngClass]="getValidationSeverityClass(issue.severity)">
              {{ getValidationTypeLabel(issue.type) }}
            </span>
            <span class="issue-description">{{ issue.description }}</span>
          </div>
        </div>
        
        <div class="question-actions">
          <button class="btn btn-sm btn-success" (click)="addValidatedQuestionToSet(result)" 
                  [disabled]="result.hasIssues">
            <i class="bi bi-plus-circle"></i> Thêm vào bộ câu hỏi
          </button>
          <button class="btn btn-sm btn-warning" *ngIf="result.hasIssues">
            <i class="bi bi-pencil"></i> Cần chỉnh sửa thủ công
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
